<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistem Absensi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: 'IBM Plex Mono', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .glass-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    
    .input-group {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    
    .form-input {
      padding-left: 3rem;
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
  
  <!-- Login Container -->
  <div class="glass-panel rounded-2xl p-8 w-full max-w-md shadow-2xl">
    
    <!-- Logo/Header -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <i class="fas fa-fingerprint text-3xl text-purple-600"></i>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">Sistem Absensi</h1>
      <p class="text-gray-300 text-sm">Masuk ke akun Anda</p>
    </div>

    <!-- Login Form -->
    <form id="login-form" class="space-y-4">
      
      <!-- Email Input -->
      <div class="input-group">
        <i class="fas fa-envelope input-icon"></i>
        <input 
          type="email" 
          id="email" 
          placeholder="Email" 
          required
          autocomplete="email"
          class="form-input w-full px-4 py-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-gray-300 focus:outline-none focus:border-white focus:bg-opacity-30 transition"
        />
      </div>
      
      <!-- Password Input -->
      <div class="input-group">
        <i class="fas fa-lock input-icon"></i>
        <input 
          type="password" 
          id="password" 
          placeholder="Password" 
          required
          autocomplete="current-password"
          class="form-input w-full px-4 py-3 rounded-lg bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-gray-300 focus:outline-none focus:border-white focus:bg-opacity-30 transition"
        />
        <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-300 hover:text-white">
          <i class="fas fa-eye" id="password-toggle"></i>
        </button>
      </div>
      
      <!-- Remember Me -->
      <div class="flex items-center justify-between">
        <label class="flex items-center text-white text-sm cursor-pointer">
          <input type="checkbox" id="remember" class="mr-2">
          <span>Ingat saya</span>
        </label>
        <a href="#" onclick="forgotPassword()" class="text-sm text-gray-300 hover:text-white">Lupa password?</a>
      </div>
      
      <!-- Submit Button -->
      <button 
        type="submit" 
        id="login-btn"
        class="w-full bg-white text-purple-600 font-bold py-3 rounded-lg hover:bg-opacity-90 transition flex items-center justify-center"
      >
        <span id="btn-text">Masuk</span>
        <div class="loader ml-2 hidden" id="btn-spinner"></div>
      </button>
      
      <!-- Status Message -->
      <div id="status-message" class="hidden text-center py-2 px-4 rounded-lg text-sm">
        <span id="status-text"></span>
      </div>
      
    </form>

    <!-- Divider -->
    <div class="flex items-center my-6">
      <div class="flex-1 h-px bg-gray-400"></div>
      <span class="px-3 text-gray-300 text-sm">atau</span>
      <div class="flex-1 h-px bg-gray-400"></div>
    </div>

    <!-- Alternative Login -->
    <div class="space-y-3">
      <button onclick="loginAnonymously()" class="w-full bg-gray-700 text-white text-center font-medium py-3 rounded-lg hover:bg-gray-600 transition">
        <i class="fas fa-user-secret mr-2"></i>
        Masuk sebagai Guest
      </button>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8">
      <p class="text-gray-300 text-xs">
        © 2024 Sistem Absensi. All rights reserved.
      </p>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { 
      getAuth, 
      signInWithEmailAndPassword,
      signInAnonymously,
      sendPasswordResetEmail,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    
    // Import Firebase config
    import { firebaseConfig } from '/firebase-config.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Check if already logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Already logged in, redirect based on email
        if (user.email) {
          if (user.email.includes('admin')) {
            window.location.href = '/admin.html';
          } else {
            window.location.href = '/employee.html';
          }
        } else {
          // Anonymous user
          window.location.href = '/employee.html';
        }
      }
    });

    // Form submission
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      // Validation
      if (!email || !password) {
        showStatus('Silakan isi semua field', 'error');
        return;
      }
      
      // Show loading
      showLoading(true);
      hideStatus();
      
      try {
        // Set persistence based on remember me
        await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);
        
        // Sign in
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log('✅ Login success:', user.email);
        showStatus('Login berhasil! Mengalihkan...', 'success');
        
        // Redirect based on user role
        setTimeout(() => {
          if (email.toLowerCase().includes('admin')) {
            window.location.href = '/admin.html';
          } else {
            window.location.href = '/employee.html';
          }
        }, 1000);
        
      } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'Login gagal. Silakan coba lagi.';
        
        switch(error.code) {
          case 'auth/invalid-email':
            errorMessage = 'Format email tidak valid';
            break;
          case 'auth/user-not-found':
            errorMessage = 'Email tidak terdaftar';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Password salah';
            break;
          case 'auth/invalid-credential':
            errorMessage = 'Email atau password salah';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Terlalu banyak percobaan. Coba lagi nanti.';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Koneksi gagal. Periksa internet Anda.';
            break;
        }
        
        showStatus(errorMessage, 'error');
        shakeForm();
      } finally {
        showLoading(false);
      }
    });

    // Login as Guest (Anonymous)
    window.loginAnonymously = async function() {
      showLoading(true);
      hideStatus();
      
      try {
        await signInAnonymously(auth);
        showStatus('Login sebagai Guest berhasil!', 'success');
        
        setTimeout(() => {
          window.location.href = '/employee.html';
        }, 1000);
        
      } catch (error) {
        console.error('Anonymous login error:', error);
        
        if (error.code === 'auth/admin-restricted-operation') {
          showStatus('Anonymous auth tidak diaktifkan. Hubungi admin.', 'error');
        } else {
          showStatus('Login gagal: ' + error.message, 'error');
        }
      } finally {
        showLoading(false);
      }
    };

    // Forgot Password
    window.forgotPassword = async function() {
      const email = document.getElementById('email').value.trim();
      
      if (!email) {
        showStatus('Masukkan email terlebih dahulu', 'error');
        document.getElementById('email').focus();
        return;
      }
      
      try {
        await sendPasswordResetEmail(auth, email);
        showStatus('Link reset password telah dikirim ke email Anda', 'success');
      } catch (error) {
        console.error('Reset password error:', error);
        showStatus('Gagal mengirim reset password', 'error');
      }
    };

    // Toggle password visibility
    window.togglePassword = function() {
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('password-toggle');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
      }
    };

    // Helper functions
    function showLoading(show) {
      const btn = document.getElementById('login-btn');
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      
      if (show) {
        btn.disabled = true;
        btnText.textContent = 'Memproses...';
        btnSpinner.classList.remove('hidden');
      } else {
        btn.disabled = false;
        btnText.textContent = 'Masuk';
        btnSpinner.classList.add('hidden');
      }
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      const statusText = document.getElementById('status-text');
      
      statusDiv.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-white');
      
      if (type === 'success') {
        statusDiv.classList.add('bg-green-500', 'text-white');
      } else if (type === 'error') {
        statusDiv.classList.add('bg-red-500', 'text-white');
      } else {
        statusDiv.classList.add('bg-yellow-500', 'text-white');
      }
      
      statusText.textContent = message;
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        hideStatus();
      }, 5000);
    }

    function hideStatus() {
      document.getElementById('status-message').classList.add('hidden');
    }

    function shakeForm() {
      const form = document.getElementById('login-form');
      form.classList.add('shake');
      setTimeout(() => form.classList.remove('shake'), 500);
    }

    // Auto-focus email field
    document.getElementById('email').focus();
  </script>
</body>
</html>
