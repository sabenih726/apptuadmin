<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absensi Karyawan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: 'IBM Plex Mono', monospace;
      background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%);
      min-height: 100vh;
    }
    
    .glass-card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    .success-animation {
      animation: successPulse 0.5s ease-out;
    }
    
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .btn-3d {
      position: relative;
      transition: all 0.3s;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    
    .btn-3d:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 rgba(0,0,0,0.2);
    }
    
    .camera-frame {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
    }
    
    .camera-frame::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 3px solid rgba(99, 102, 241, 0.3);
      border-radius: 1rem;
      pointer-events: none;
      z-index: 1;
    }
    
    .pulse-dot {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 12px;
      height: 12px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
      z-index: 2;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
  </style>
</head>

<body class="flex flex-col items-center justify-start min-h-screen p-4">

  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass-card rounded-2xl p-8 max-w-sm success-animation">
      <div class="text-center">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-check text-white text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Absensi Berhasil!</h3>
        <p class="text-gray-400 text-sm mb-4">Data absensi Anda telah tersimpan</p>
        <button onclick="closeSuccessModal()" class="btn-3d bg-green-500 text-white px-6 py-2 rounded-lg">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Main Card -->
  <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl p-6 mb-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-700">
      <h1 class="text-xl font-bold text-white flex items-center">
        <i class="fas fa-fingerprint mr-3 text-indigo-400"></i>
        Absensi Digital
      </h1>
      <div class="flex items-center gap-2">
        <span id="connection-status" class="flex items-center text-xs">
          <i class="fas fa-wifi text-green-400 mr-1"></i>
          <span class="text-gray-400">Online</span>
        </span>
      </div>
    </div>

    <!-- User Info -->
    <div id="user-info" class="bg-slate-800 rounded-lg p-3 mb-4 hidden">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-indigo-500 rounded-full flex items-center justify-center">
          <i class="fas fa-user text-white"></i>
        </div>
        <div>
          <p id="user-name" class="font-semibold text-white">Guest User</p>
          <p id="user-email" class="text-xs text-gray-400">guest@example.com</p>
        </div>
      </div>
    </div>

    <!-- Status Display -->
    <div class="mb-4">
      <div class="bg-slate-800 rounded-lg p-3">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-400">Status</span>
          <span id="current-time" class="text-xs text-gray-500"></span>
        </div>
        <div id="status-container">
          <p id="status-message" class="text-gray-300 flex items-center">
            <i class="fas fa-circle-notch fa-spin mr-2 text-indigo-400"></i>
            Memuat sistem...
          </p>
          <div id="location-info" class="mt-2 text-xs text-gray-500 hidden">
            <i class="fas fa-map-marker-alt mr-1"></i>
            <span id="location-text">Mendapatkan lokasi...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Section -->
    <div class="mb-4">
      <div class="camera-frame bg-gray-900">
        <div class="pulse-dot hidden" id="camera-indicator"></div>
        <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
        <canvas id="canvas-capture" class="hidden w-full h-full object-cover"></canvas>
        <canvas id="canvas-hidden" class="hidden"></canvas>
        
        <div id="video-placeholder" class="flex flex-col items-center justify-center py-16 text-gray-500">
          <i class="fas fa-camera text-4xl mb-3 opacity-50"></i>
          <p class="text-sm">Kamera belum aktif</p>
        </div>
        
        <!-- Capture Overlay -->
        <div id="capture-overlay" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
      </div>
    </div>

    <!-- Attendance Type Selection -->
    <div id="attendance-type" class="mb-4 hidden">
      <label class="block text-sm font-medium text-gray-400 mb-2">Jenis Absensi</label>
      <div class="grid grid-cols-2 gap-2">
        <button onclick="setAttendanceType('masuk')" class="attendance-type-btn" data-type="masuk">
          <i class="fas fa-sign-in-alt mr-2"></i>Masuk
        </button>
        <button onclick="setAttendanceType('pulang')" class="attendance-type-btn" data-type="pulang">
          <i class="fas fa-sign-out-alt mr-2"></i>Pulang
        </button>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="flex flex-col gap-3">
      <button id="start-btn" class="btn-3d bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center" disabled>
        <i class="fas fa-power-off mr-2"></i>
        Mulai Absensi
      </button>
      
      <button id="capture-btn" class="btn-3d bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all hidden flex items-center justify-center">
        <i class="fas fa-camera mr-2"></i>
        Ambil Foto
      </button>
      
      <button id="submit-btn" class="btn-3d bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-all hidden flex items-center justify-center">
        <i class="fas fa-paper-plane mr-2"></i>
        Kirim Absensi
      </button>
      
      <button id="reset-btn" class="btn-3d bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-all hidden flex items-center justify-center">
        <i class="fas fa-redo mr-2"></i>
        Ulangi
      </button>
    </div>

    <!-- Additional Info -->
    <div class="mt-4 p-3 bg-blue-900 bg-opacity-30 rounded-lg hidden" id="info-box">
      <p class="text-xs text-blue-300 flex items-center">
        <i class="fas fa-info-circle mr-2"></i>
        Pastikan wajah Anda terlihat jelas dan pencahayaan cukup
      </p>
    </div>
  </div>

  <!-- History Card -->
  <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold text-white flex items-center">
        <i class="fas fa-history mr-2 text-indigo-400"></i>
        Riwayat Hari Ini
      </h2>
      <button onclick="refreshHistory()" class="text-gray-400 hover:text-white">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    
    <div id="history-container" class="space-y-2 max-h-64 overflow-y-auto">
      <!-- History items will be inserted here -->
    </div>
    
    <div id="empty-history" class="text-center py-8 text-gray-500">
      <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
      <p class="text-sm">Belum ada riwayat hari ini</p>
    </div>
  </div>

  <!-- Enhanced JavaScript -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc,
      query,
      where,
      orderBy,
      onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    import { 
      getAuth, 
      onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL 
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';

    // Initialize Firebase
    const firebaseConfig = {
      // Your config
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Global variables
    let video, canvas, canvasHidden, context, contextHidden;
    let photoData = null;
    let currentUser = null;
    let userLocation = null;
    let attendanceType = 'masuk';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initializeElements();
      checkAuth();
      updateClock();
      getUserLocation();
      setupOfflineDetection();
    });

    function initializeElements() {
      video = document.getElementById('video');
      canvas = document.getElementById('canvas-capture');
      canvasHidden = document.getElementById('canvas-hidden');
      context = canvas.getContext('2d');
      contextHidden = canvasHidden.getContext('2d');

      // Button handlers
      document.getElementById('start-btn').onclick = startCamera;
      document.getElementById('capture-btn').onclick = capturePhoto;
      document.getElementById('submit-btn').onclick = submitAttendance;
      document.getElementById('reset-btn').onclick = resetProcess;
    }

    // Check authentication
    function checkAuth() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          document.getElementById('user-info').classList.remove('hidden');
          document.getElementById('user-name').textContent = user.displayName || 'User';
          document.getElementById('user-email').textContent = user.email;
        } else {
          currentUser = { uid: 'guest', email: 'guest@example.com', displayName: 'Guest User' };
        }
        document.getElementById('start-btn').disabled = false;
        updateStatus('Sistem siap digunakan', 'success');
        loadTodayHistory();
      });
    }

    // Get user location
    async function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            
            // Reverse geocoding
            try {
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?lat=${userLocation.lat}&lon=${userLocation.lng}&format=json`
              );
              const data = await response.json();
              const city = data.address?.city || data.address?.town || 'Unknown';
              
              document.getElementById('location-info').classList.remove('hidden');
              document.getElementById('location-text').textContent = city;
              userLocation.city = city;
            } catch (error) {
              console.error('Geocoding error:', error);
            }
          },
          (error) => {
            console.error('Location error:', error);
            updateStatus('Lokasi tidak dapat diakses', 'warning');
          }
        );
      }
    }

    // Start camera
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('video-placeholder').style.display = 'none';
        document.getElementById('camera-indicator').classList.remove('hidden');
        
        document.getElementById('start-btn').classList.add('hidden');
        document.getElementById('capture-btn').classList.remove('hidden');
        document.getElementById('attendance-type').classList.remove('hidden');
        document.getElementById('info-box').classList.remove('hidden');
        
        updateStatus('Kamera aktif, silakan ambil foto', 'info');
      } catch (error) {
        console.error('Camera error:', error);
        updateStatus('Gagal mengakses kamera', 'error');
      }
    }

    // Capture photo
    function capturePhoto() {
      // Flash effect
      const overlay = document.getElementById('capture-overlay');
      overlay.style.opacity = '1';
      setTimeout(() => { overlay.style.opacity = '0'; }, 200);

      // Draw to canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      
      canvasHidden.width = video.videoWidth;
      canvasHidden.height = video.videoHeight;
      contextHidden.drawImage(video, 0, 0);
      
      photoData = canvasHidden.toDataURL('image/jpeg', 0.8);
      
      // Show captured image
      canvas.style.display = 'block';
      video.style.display = 'none';
      
      document.getElementById('capture-btn').classList.add('hidden');
      document.getElementById('submit-btn').classList.remove('hidden');
      document.getElementById('reset-btn').classList.remove('hidden');
      
      updateStatus('Foto berhasil diambil', 'success');
    }

    // Submit attendance
    async function submitAttendance() {
      if (!photoData) {
        updateStatus('Silakan ambil foto terlebih dahulu', 'error');
        return;
      }

      updateStatus('Mengirim data...', 'loading');
      document.getElementById('submit-btn').disabled = true;

      try {
        // Upload photo to storage
        const photoBlob = dataURLtoBlob(photoData);
        const fileName = `attendance/${currentUser.uid}_${Date.now()}.jpg`;
        const storageRef = ref(storage, fileName);
        
        const snapshot = await uploadBytes(storageRef, photoBlob);
        const photoURL = await getDownloadURL(snapshot.ref);

        // Save to Firestore
        const attendanceData = {
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Guest',
          userEmail: currentUser.email,
          timestamp: new Date(),
          type: attendanceType,
          status: 'hadir',
          photoURL: photoURL,
          location: userLocation,
          device: {
            userAgent: navigator.userAgent,
            platform: navigator.platform
          }
        };

        await addDoc(collection(db, 'attendance'), attendanceData);
        
        // Show success
        showSuccessModal();
        updateStatus('Absensi berhasil disimpan!', 'success');
        
        // Reset after delay
        setTimeout(resetProcess, 2000);
        
      } catch (error) {
        console.error('Submit error:', error);
        updateStatus('Gagal mengirim absensi', 'error');
        
        // Save to local storage if offline
        if (!navigator.onLine) {
          saveOfflineData(attendanceData);
          updateStatus('Disimpan offline, akan dikirim saat online', 'warning');
        }
      } finally {
        document.getElementById('submit-btn').disabled = false;
      }
    }

    // Reset process
    function resetProcess() {
      // Stop camera
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      // Reset UI
      video.style.display = 'none';
      canvas.style.display = 'none';
      document.getElementById('video-placeholder').style.display = 'flex';
      document.getElementById('camera-indicator').classList.add('hidden');
      
      document.getElementById('start-btn').classList.remove('hidden');
      document.getElementById('capture-btn').classList.add('hidden');
      document.getElementById('submit-btn').classList.add('hidden');
      document.getElementById('reset-btn').classList.add('hidden');
      document.getElementById('attendance-type').classList.add('hidden');
      document.getElementById('info-box').classList.add('hidden');
      
      photoData = null;
      updateStatus('Sistem siap digunakan', 'success');
    }

    // Load today's history
    function loadTodayHistory() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const q = query(
        collection(db, 'attendance'),
        where('userId', '==', currentUser.uid),
        where('timestamp', '>=', today),
        orderBy('timestamp', 'desc')
      );

      onSnapshot(q, (snapshot) => {
        const historyContainer = document.getElementById('history-container');
        const emptyHistory = document.getElementById('empty-history');
        
        if (snapshot.empty) {
          historyContainer.style.display = 'none';
          emptyHistory.style.display = 'block';
        } else {
          historyContainer.style.display = 'block';
          emptyHistory.style.display = 'none';
          
          historyContainer.innerHTML = snapshot.docs.map(doc => {
            const data = doc.data();
            const time = data.timestamp.toDate().toLocaleTimeString('id-ID', {
              hour: '2-digit',
              minute: '2-digit'
            });
            
            return `
              <div class="bg-slate-800 rounded-lg p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-green-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-check text-green-400"></i>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-white">${data.type === 'masuk' ? 'Masuk' : 'Pulang'}</p>
                    <p class="text-xs text-gray-400">${time}</p>
                  </div>
                </div>
                <span class="text-xs text-gray-500">${data.location?.city || 'Unknown'}</span>
              </div>
            `;
          }).join('');
        }
      });
    }

    // Helper functions
    function updateStatus(message, type = 'info') {
      const statusMessage = document.getElementById('status-message');
      let icon = '';
      let color = '';
      
      switch(type) {
        case 'success':
          icon = '<i class="fas fa-check-circle mr-2 text-green-400"></i>';
          color = 'text-green-300';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle mr-2 text-red-400"></i>';
          color = 'text-red-300';
          break;
        case 'warning':
          icon = '<i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i>';
          color = 'text-yellow-300';
          break;
        case 'loading':
          icon = '<i class="fas fa-circle-notch fa-spin mr-2 text-indigo-400"></i>';
          color = 'text-indigo-300';
          break;
        default:
          icon = '<i class="fas fa-info-circle mr-2 text-blue-400"></i>';
          color = 'text-blue-300';
      }
      
      statusMessage.className = `${color} flex items-center`;
      statusMessage.innerHTML = icon + message;
    }

    function updateClock() {
      const updateTime = () => {
        const now = new Date();
        document.getElementById('current-time').textContent = 
          now.toLocaleTimeString('id-ID', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
          });
      };
      updateTime();
      setInterval(updateTime, 1000);
    }

    function setupOfflineDetection() {
      const updateConnectionStatus = () => {
        const statusEl = document.getElementById('connection-status');
        if (navigator.onLine) {
          statusEl.innerHTML = '<i class="fas fa-wifi text-green-400 mr-1"></i><span class="text-gray-400">Online</span>';
          // Sync offline data if any
          syncOfflineData();
        } else {
          statusEl.innerHTML = '<i class="fas fa-wifi-slash text-red-400 mr-1"></i><span class="text-gray-400">Offline</span>';
        }
      };
      
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
      updateConnectionStatus();
    }

    function dataURLtoBlob(dataURL) {
      const parts = dataURL.split(',');
      const byteString = atob(parts[1]);
      const mimeString = parts[0].match(/:(.*?);/)[1];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      
      return new Blob([ab], { type: mimeString });
    }

    function saveOfflineData(data) {
      const offlineData = JSON.parse(localStorage.getItem('offlineAttendance') || '[]');
      offlineData.push(data);
      localStorage.setItem('offlineAttendance', JSON.stringify(offlineData));
    }

    async function syncOfflineData() {
      const offlineData = JSON.parse(localStorage.getItem('offlineAttendance') || '[]');
      if (offlineData.length > 0) {
        for (const data of offlineData) {
          try {
            await addDoc(collection(db, 'attendance'), data);
          } catch (error) {
            console.error('Sync error:', error);
          }
        }
        localStorage.removeItem('offlineAttendance');
        updateStatus('Data offline berhasil disinkronkan', 'success');
      }
    }

    window.setAttendanceType = function(type) {
      attendanceType = type;
      document.querySelectorAll('.attendance-type-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-300');
      });
      
      const selectedBtn = document.querySelector(`[data-type="${type}"]`);
      selectedBtn.classList.remove('bg-gray-700', 'text-gray-300');
      selectedBtn.classList.add('bg-indigo-600', 'text-white');
    };

    window.showSuccessModal = function() {
      document.getElementById('success-modal').classList.remove('hidden');
    };

    window.closeSuccessModal = function() {
      document.getElementById('success-modal').classList.add('hidden');
    };

    window.refreshHistory = function() {
      loadTodayHistory();
      const btn = event.target;
      btn.classList.add('animate-spin');
      setTimeout(() => btn.classList.remove('animate-spin'), 1000);
    };

    // Add CSS for attendance type buttons
    const style = document.createElement('style');
    style.textContent = `
      .attendance-type-btn {
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s;
        background: #374151;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .attendance-type-btn:hover {
        background: #4b5563;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
