<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kelola Karyawan - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: 'IBM Plex Mono', monospace;
      background: #0f172a;
      color: #e2e8f0;
    }
    .section-card {
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.25rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body class="min-h-screen p-6">
  
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="section-card mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-blue-400">
            <i class="fas fa-users-cog mr-2"></i>
            Kelola Karyawan
          </h1>
          <p class="text-gray-400 text-sm mt-1">Tambah, edit, atau nonaktifkan akun karyawan</p>
        </div>
        <div class="space-x-3">
          <a href="admin.html" class="text-gray-400 hover:text-white text-sm">
            <i class="fas fa-chart-line mr-1"></i>
            Dashboard
          </a>
          <button id="logout-btn" class="text-red-400 hover:text-red-300 text-sm">
            <i class="fas fa-sign-out-alt mr-1"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Form Tambah Karyawan -->
      <div class="lg:col-span-1">
        <div class="section-card">
          <h2 class="text-lg font-semibold mb-4 border-b border-gray-700 pb-2">
            <i class="fas fa-user-plus mr-2 text-green-400"></i>
            Tambah Karyawan Baru
          </h2>
          
          <form id="add-employee-form" class="space-y-3">
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-user mr-1"></i>
                Nama Lengkap *
              </label>
              <input 
                type="text" 
                id="emp-name" 
                required
                class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                placeholder="John Doe"
              >
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-envelope mr-1"></i>
                Email *
              </label>
              <input 
                type="email" 
                id="emp-email" 
                required
                class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                placeholder="john@company.com"
              >
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-lock mr-1"></i>
                Password * (min 6 karakter)
              </label>
              <div class="relative">
                <input 
                  type="password" 
                  id="emp-password" 
                  required
                  minlength="6"
                  class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none pr-10"
                  placeholder="••••••••"
                >
                <button type="button" id="toggle-password" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                  <i class="fas fa-eye" id="password-icon"></i>
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-id-card mr-1"></i>
                NIK (Nomor Induk Karyawan)
              </label>
              <input 
                type="text" 
                id="emp-nik" 
                class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                placeholder="1234567890"
              >
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-briefcase mr-1"></i>
                Jabatan
              </label>
              <select 
                id="emp-position" 
                class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
              >
                <option value="">Pilih Jabatan</option>
                <option value="Staff">Staff</option>
                <option value="Supervisor">Supervisor</option>
                <option value="Manager">Manager</option>
                <option value="Director">Director</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-1">
                <i class="fas fa-building mr-1"></i>
                Departemen
              </label>
              <input 
                type="text" 
                id="emp-department" 
                class="w-full p-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                placeholder="IT, Finance, HR, dll"
              >
            </div>
            
            <button 
              type="submit"
              id="submit-btn"
              class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-2 px-4 rounded font-semibold transition"
            >
              <i class="fas fa-plus mr-2"></i>
              Tambah Karyawan
            </button>
            
            <div id="add-status" class="text-sm text-center p-2 rounded hidden"></div>
          </form>
        </div>
        
        <!-- Info Card -->
        <div class="section-card mt-4 bg-blue-900 bg-opacity-20 border border-blue-700">
          <h3 class="text-sm font-semibold text-blue-400 mb-2">
            <i class="fas fa-info-circle mr-1"></i>
            Informasi
          </h3>
          <ul class="text-xs text-gray-300 space-y-1">
            <li>• Password akan diberikan ke karyawan</li>
            <li>• Karyawan bisa ganti password nanti</li>
            <li>• Email harus unik (tidak boleh duplikat)</li>
            <li>• Status default: Aktif</li>
          </ul>
        </div>
      </div>

      <!-- List Karyawan -->
      <div class="lg:col-span-2">
        <div class="section-card">
          <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
            <div>
              <h2 class="text-lg font-semibold">
                <i class="fas fa-list mr-2 text-blue-400"></i>
                Daftar Karyawan
              </h2>
              <p class="text-xs text-gray-400 mt-1">
                Total: <span id="total-employees" class="text-white font-semibold">0</span> karyawan
              </p>
            </div>
            <button id="refresh-list" class="text-blue-400 hover:text-blue-300 text-sm">
              <i class="fas fa-sync-alt mr-1"></i>
              Refresh
            </button>
          </div>
          
          <div class="overflow-auto" style="max-height: 70vh;">
            <table class="w-full">
              <thead class="sticky top-0 bg-gray-800">
                <tr class="border-b border-gray-700 text-xs">
                  <th class="p-2 text-left">Nama</th>
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">NIK</th>
                  <th class="p-2 text-left">Jabatan</th>
                  <th class="p-2 text-left">Status</th>
                  <th class="p-2 text-left">Aksi</th>
                </tr>
              </thead>
              <tbody id="employee-list">
                <tr>
                  <td colspan="6" class="text-center py-12 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                    <p>Memuat data karyawan...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, COLLECTIONS, ROLES, isAdmin } from '/firebase-config.js';
    import { 
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    import { 
      collection,
      doc,
      setDoc,
      getDocs,
      deleteDoc,
      updateDoc,
      serverTimestamp,
      query,
      where,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    console.log('👥 Employee Management Page Loaded');

    // Check if user is admin
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '/login.html';
        return;
      }
      
      const userIsAdmin = await isAdmin(user.uid);
      if (!userIsAdmin) {
        alert('Access denied. Admin only.');
        window.location.href = '/admin.html';
        return;
      }
      
      console.log('✅ Admin access granted');
      loadEmployees();
    });

    // Toggle password visibility
    document.getElementById('toggle-password').addEventListener('click', () => {
      const input = document.getElementById('emp-password');
      const icon = document.getElementById('password-icon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });

    // Add Employee
    document.getElementById('add-employee-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('emp-name').value.trim();
      const email = document.getElementById('emp-email').value.trim();
      const password = document.getElementById('emp-password').value;
      const nik = document.getElementById('emp-nik').value.trim();
      const position = document.getElementById('emp-position').value;
      const department = document.getElementById('emp-department').value.trim();
      const statusEl = document.getElementById('add-status');
      const submitBtn = document.getElementById('submit-btn');
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        statusEl.textContent = 'Membuat akun karyawan...';
        statusEl.className = 'text-sm text-center p-2 rounded bg-yellow-900 bg-opacity-30 text-yellow-400';
        statusEl.classList.remove('hidden');
        
        // Create auth account
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        
        console.log('✅ Auth account created:', uid);
        
        // Create user document in Firestore
        await setDoc(doc(db, COLLECTIONS.USERS, uid), {
          uid: uid,
          email: email,
          name: name,
          nik: nik || '',
          position: position || 'Staff',
          department: department || '',
          role: 'employee',
          active: true,
          createdAt: serverTimestamp(),
          createdBy: auth.currentUser.uid
        });
        
        console.log('✅ User document created');
        
        statusEl.textContent = `✅ Karyawan ${name} berhasil ditambahkan!`;
        statusEl.className = 'text-sm text-center p-2 rounded bg-green-900 bg-opacity-30 text-green-400';
        
        // Show credentials
        alert(`Karyawan berhasil ditambahkan!\n\nEmail: ${email}\nPassword: ${password}\n\nBerikan informasi ini ke karyawan untuk login pertama kali.`);
        
        // Reset form
        e.target.reset();
        
        // Reload list
        setTimeout(() => {
          loadEmployees();
          statusEl.classList.add('hidden');
        }, 2000);
        
      } catch (error) {
      console.error('❌ Error:', error);
      
      let errorMsg = 'Gagal menambahkan karyawan';
      let errorDetail = '';
      let showAlert = false;
      
      // ✅ IMPROVED ERROR MESSAGES
      switch(error.code) {
        case 'auth/email-already-in-use':
          errorMsg = 'Email sudah terdaftar';
          errorDetail = `Email "${email}" sudah digunakan oleh user lain.`;
          showAlert = true;
          
          // ✅ Check if user exists in Firestore
          try {
            const existingUserQuery = query(
              collection(db, COLLECTIONS.USERS),
              where('email', '==', email)
            );
            const existingUserSnap = await getDocs(existingUserQuery);
            
            if (!existingUserSnap.empty) {
              errorDetail += '\n\nUser sudah terdaftar di database.';
            } else {
              errorDetail += '\n\nUser ada di Auth tapi tidak ada di database. Hubungi IT untuk fix.';
            }
          } catch (checkError) {
            console.error('Error checking existing user:', checkError);
          }
          break;
          
        case 'auth/invalid-email':
          errorMsg = 'Format email tidak valid';
          errorDetail = 'Pastikan format email benar (contoh: nama@company.com)';
          break;
          
        case 'auth/weak-password':
          errorMsg = 'Password terlalu lemah';
          errorDetail = 'Password minimal 6 karakter';
          break;
          
        case 'permission-denied':
          errorMsg = 'Permission denied';
          errorDetail = 'Tidak ada akses ke Firestore. Cek Firestore rules!';
          showAlert = true;
          break;
          
        default:
          errorMsg = 'Gagal menambahkan karyawan';
          errorDetail = error.message;
      }
      
      // Show error in status element
      statusEl.innerHTML = `
        <div>
          <p class="font-semibold">❌ ${errorMsg}</p>
          <p class="text-xs mt-1 opacity-90">${errorDetail}</p>
        </div>
      `;
      statusEl.className = 'text-sm text-center p-3 rounded bg-red-900 bg-opacity-30 text-red-400';
      
      // Show alert for critical errors
      if (showAlert) {
        setTimeout(() => {
          alert(`⚠️ ${errorMsg}\n\n${errorDetail}`);
        }, 500);
      }
      
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Tambah Karyawan';
    }
    });

    // Load Employees
    async function loadEmployees() {
      const tbody = document.getElementById('employee-list');
      const totalEl = document.getElementById('total-employees');
      
      try {
        const q = query(
          collection(db, COLLECTIONS.USERS),
          where('role', '==', 'employee'),
          orderBy('createdAt', 'desc')
        );
        
        const snapshot = await getDocs(q);
        
        totalEl.textContent = snapshot.size;
        
        if (snapshot.empty) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-12 text-gray-500">
                <i class="fas fa-users text-4xl mb-2 opacity-30"></i>
                <p>Belum ada karyawan terdaftar</p>
                <p class="text-xs mt-2">Tambahkan karyawan baru menggunakan form di sebelah kiri</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = snapshot.docs.map(docSnap => {
          const data = docSnap.data();
          const statusColor = data.active ? 'text-green-400' : 'text-red-400';
          const statusBg = data.active ? 'bg-green-900' : 'bg-red-900';
          const statusText = data.active ? 'Aktif' : 'Nonaktif';
          const statusIcon = data.active ? 'fa-check-circle' : 'fa-times-circle';
          
          return `
            <tr class="border-b border-gray-800 hover:bg-gray-800 transition text-sm">
              <td class="p-2">
                <div class="flex items-center">
                  <i class="fas fa-user-circle text-gray-500 mr-2"></i>
                  <span class="font-semibold">${data.name || '-'}</span>
                </div>
              </td>
              <td class="p-2 text-gray-400">${data.email || '-'}</td>
              <td class="p-2 text-gray-400">${data.nik || '-'}</td>
              <td class="p-2">
                <span class="px-2 py-1 bg-blue-900 bg-opacity-30 text-blue-400 rounded text-xs">
                  ${data.position || 'Staff'}
                </span>
              </td>
              <td class="p-2">
                <span class="inline-flex items-center px-2 py-1 ${statusBg} bg-opacity-30 ${statusColor} rounded text-xs">
                  <i class="fas ${statusIcon} mr-1"></i>
                  ${statusText}
                </span>
              </td>
              <td class="p-2">
                <div class="flex items-center space-x-2">
                  <button 
                    onclick="toggleStatus('${docSnap.id}', ${!data.active}, '${data.name}')" 
                    class="text-yellow-400 hover:text-yellow-300" 
                    title="${data.active ? 'Nonaktifkan' : 'Aktifkan'}"
                  >
                    <i class="fas fa-power-off"></i>
                  </button>
                  <button 
                    onclick="viewDetails('${docSnap.id}')" 
                    class="text-blue-400 hover:text-blue-300" 
                    title="Detail"
                  >
                    <i class="fas fa-info-circle"></i>
                  </button>
                  <button 
                    onclick="deleteEmployee('${docSnap.id}', '${data.email}', '${data.name}')" 
                    class="text-red-400 hover:text-red-300" 
                    title="Hapus"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        console.log(`✅ Loaded ${snapshot.size} employees`);
        
      } catch (error) {
        console.error('❌ Load error:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-8 text-red-400">
              <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
              <p>Error: ${error.message}</p>
            </td>
          </tr>
        `;
      }
    }

    // Toggle Status
    window.toggleStatus = async function(userId, newStatus, name) {
      const action = newStatus ? 'mengaktifkan' : 'menonaktifkan';
      
      if (!confirm(`${action} akun ${name}?`)) {
        return;
      }
      
      try {
        await updateDoc(doc(db, COLLECTIONS.USERS, userId), {
          active: newStatus,
          updatedAt: serverTimestamp(),
          updatedBy: auth.currentUser.uid
        });
        
        console.log(`✅ ${name} status updated to ${newStatus}`);
        loadEmployees();
        
      } catch (error) {
        console.error('Toggle error:', error);
        alert('Gagal mengubah status: ' + error.message);
      }
    };

    // View Details
    window.viewDetails = function(userId) {
      // You can implement a modal to show full employee details
      alert('Feature coming soon: View employee details and edit info');
    };

    // Delete Employee
    window.deleteEmployee = async function(userId, email, name) {
      const confirmation = prompt(
        `PERINGATAN: Hapus karyawan ${name}?\n\n` +
        `Ketik "${email}" untuk konfirmasi:`
      );
      
      if (confirmation !== email) {
        alert('Konfirmasi dibatalkan');
        return;
      }
      
      try {
        await deleteDoc(doc(db, COLLECTIONS.USERS, userId));
        
        console.log(`✅ ${name} deleted`);
        alert(`Karyawan ${name} berhasil dihapus.\n\nCATATAN: Account Firebase Auth masih ada, hanya data Firestore yang dihapus.`);
        
        loadEmployees();
        
      } catch (error) {
        console.error('Delete error:', error);
        alert('Gagal menghapus: ' + error.message);
      }
    };

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      if (!confirm('Logout dari admin panel?')) return;
      
      try {
        await signOut(auth);
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Refresh
    document.getElementById('refresh-list').addEventListener('click', () => {
      loadEmployees();
    });
  </script>
</body>
</html>
